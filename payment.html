<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üí≥ Royal Payment</title>
<style>
  body {
    font-family: "Poppins", sans-serif;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-image: url('hall.jpg');
    background-size: cover;
    color: #fff;
  }
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.75); z-index: -1;
  }
  .payment-box {
    background: rgba(40,0,0,0.85);
    padding: 30px;
    border-radius: 16px;
    width: 400px;
    text-align: center;
    border: 2px solid gold;
    box-shadow: 0 0 25px rgba(255,215,0,0.4);
  }
  h1 { color: gold; font-size: 32px; margin-bottom: 20px; }
  .order-type { font-size: 20px; color: #ffdf6c; font-weight: bold; margin-bottom: 10px; }
  .amount { font-size: 24px; color: #ffdf6c; margin-bottom: 15px; }
  label { display: block; text-align: left; margin-top: 10px; }
  input, button { width: 100%; margin-top: 8px; padding: 10px; border-radius: 10px; border: none; font-size: 16px; }
  input { background: rgba(255,255,255,0.2); color: #000; }
  button { background: linear-gradient(45deg,#8B0000,#B22222); color: gold; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }
  button:hover { transform: scale(1.05); }
  #msg { display: none; margin-top: 15px; color: #ffdf6c; font-weight: bold; }
  .back { display: block; margin-top: 10px; cursor: pointer; text-decoration: underline; color: #ffdf6c; }
</style>
</head>
<body>
<div class="overlay"></div>

<div class="payment-box">
  <h1>üí≥ Royal UPI Payment</h1>

  <div class="order-type" id="orderTypeBox"></div>
  <div class="amount" id="amountBox">Total: ‚Çπ0</div>

  <label for="upiId">Enter your UPI ID</label>
  <input type="text" id="upiId" placeholder="example@upi">

  <label for="password">Enter Payment Password</label>
  <input type="password" id="password" placeholder="Enter your password">

  <button onclick="makePayment()">üí∞ Pay with UPI</button>

  <div id="msg"></div>
  <span class="back" onclick="goBack()">‚¨ÖÔ∏è Back to Cart</span>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const amount = parseInt(urlParams.get("amount")) || 0;
  document.getElementById("amountBox").innerText = "Total: ‚Çπ" + amount;

  const orderType = localStorage.getItem("orderType") || "dine-in";
  document.getElementById("orderTypeBox").innerText =
    `Order Type: ${orderType === 'dine-in' ? 'üçΩÔ∏è Dine-In' : 'üì¶ Takeaway'}`;

  async function makePayment() {
    const upiId = document.getElementById("upiId").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!upiId || !password) {
      alert("‚ö†Ô∏è Please enter both UPI ID & payment password.");
      return;
    }

    const customer = JSON.parse(localStorage.getItem("customerData")) || {};
    const cartItems = JSON.parse(localStorage.getItem("cart")) || [];

    // Convert cart items to MongoDB format
    const items = cartItems.map(i => ({
      name: i.name,
      qty: i.qty,
      price: i.price
    }));

    // FINAL ORDER MATCHING YOUR Order.js
    const newOrder = {
      customer: {
        name: customer.name || "Guest",
        email: customer.email || "",
        phone: customer.phone || "",
        table: customer.table || ""
      },
      items: items,
      total: amount,
      paymentStatus: "paid",
      paymentMethod: "UPI",
      upiId: upiId
    };

    try {
      const response = await fetch("http://localhost:5000/api/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newOrder)
      });

      const result = await response.json();

      if (response.ok) {
        document.getElementById("msg").style.display = "block";
        document.getElementById("msg").innerText =
          "‚úÖ Payment Successful! Order Saved.";

        // clear cart
        localStorage.removeItem("cart");

        setTimeout(() => {
          window.location.href = "success.html";
        }, 2000);

      } else {
        alert("‚ùå Error: " + result.message);
      }

    } catch (error) {
      console.error("Error:", error);
      alert("‚ö†Ô∏è Something went wrong. Please try again.");
    }
  }

  function goBack() {
    window.location.href = "cart.html";
  }
</script>

</body>
</html>
